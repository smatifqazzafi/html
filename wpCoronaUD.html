<body>

    <head>

        <link rel="stylesheet" href="MyAssets/Scripts/css/jquery.dataTables.min.css">
        <link rel="stylesheet" href="MyAssets/Scripts/css/buttons.dataTables.min.css">
        <link rel="stylesheet" href="MyAssets/Scripts/css/jquery.contextMenu.min.css">
        <link rel="stylesheet" href="MyAssets/Scripts/css/MyCommonCss.css">
        <link rel="stylesheet" href="MyAssets/Scripts/css/bootstrap-multiselect.css">
        <style>
            #dataTable tbody tr.dtrg-group.dtrg-start.dtrg-level-0 {
                background-color: var(--colors_backgroundcolor) !Important;
            }

            /* Investigation Work Start */

            .tag-input-container {
                display: flex;
                flex-wrap: wrap;
                border: 1px solid rgb(150, 150, 150);
                padding: 5px;
                border-radius: 5px;
                width: 98%;
                /* Set the width as needed */
            }

            .tag {
                border: 1px solid #aaa;
                color: #000;
                padding: 5px 10px;
                margin: 5px;
                border-radius: 5px;
                display: flex;
                align-items: center;
            }

            .tag .close {
                cursor: pointer;
                margin-left: 5px;
            }

            .tag-input {
                border: none;
                outline: none;
                flex-grow: 1;
            }

            .floatingContainerClass {
                background: white;
                z-index: 20;
                position: fixed;
                left: 20%;
                width: 60%;
                top: 0;
                padding: 10px;
                opacity: 0;
                transition: all 0.3s ease-out;
                display: block;
                z-index: -1;
            }

            #fullScreenDiv {
                top: 0;
                left: 0;
                position: fixed;
                width: 100%;
                height: 100%;
                display: none;
                z-index: 15;
            }

            #grayContainer {
                top: 0;
                left: 0;
                position: fixed;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.2);
            }

            #textRowsSelected {
                float: left;
                margin-right: 10px;
            }

            #buttonDoActionOnSelectedContainer {
                float: right;
            }

            .buttonDoAction {
                margin-right: 8px;
                text-decoration: underline;
                cursor: pointer;
                color: var(--colors_basecolor);
                /* #f87f6a; */
            }

            .MyGridTextBox {
                margin-top: 1px !Important;
                margin-bottom: 1px !Important;
                margin-left: 1px !Important;
                display: block;
                height: 26px;
                padding: 5px 5px;
                font-size: 10px;
                line-height: 1.42857143;
                color: #555;
                background-color: #fff;
                background-image: none;
                border: 1px solid #ccc;
                border-radius: 4px;
                -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
                box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
                -webkit-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
                -o-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
                -webkit-transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
                transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
                transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
                transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
                width: -webkit-fill-available !Important;
                min-height: 10px !Important;
            }

            /* .loader-btn {
                position: absolute !Important;
            } */

            .loader-btn .loader {
                /* position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%); */
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                /* width: 20px;
                height: 20px; 
                animation: spin 1s linear infinite;*/
                display: none;
            }

            @keyframes spin {
                0% {
                    transform: translate(-50%, -50%) rotate(0deg);
                }

                100% {
                    transform: translate(-50%, -50%) rotate(360deg);
                }
            }

            #filterPanel {
                background-color: #f0f0f0;
                border: 1px solid #ccc;
                padding: 6px;
                border-radius: 5px;
                display: flex;
                align-items: center;
                margin-bottom: 10px;
            }

            #filterMessage {
                margin: 0;
            }

            .clearFilterButton {
                margin-left: 10px;
                padding: 5px 10px;
                color: #fff;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                min-width: 0px !Important;
            }

            /*  .dt-button {
                white-space: nowrap !Important;
                background-color: var(--colors_basecolor) !Important;
                color: var(--colors_baseforecolor) !Important;
                border: var(--borders_xs) solid var(--colors_actionborder_and_focuscolor) !Important;
                text-align: center !Important;
                text-indent: 0 !Important;
                vertical-align: middle !Important;
                box-shadow: 0 7px 10px -5px var(--colors_basecolorshadow) !Important;
                border-radius: var(--radius_m) !Important;
            } */
            .cTdPad {
                padding-left: 8px;
                padding-right: 20px;
                border: 1px solid;
            }

            .thS {
                padding: 2px;
                padding-right: 20px;
                padding-left: 8px;
                background: var(--colors_basecolor);
                /* #2F4858; */
                color: white;
                font-weight: 500;
            }

            .context-menu-icon-match {
                background-image: url(Resources/DDOMultiselSelOption.png) !Important;
                background-repeat: no-repeat;
                background-position: left;
            }

            .context-menu-icon-unmatch {
                background-image: url(Resources/ActionFiltersClean.png) !Important;
                background-repeat: no-repeat;
                background-position: left;
                background-size: 13px !important;
            }

            .context-menu-icon-vhistory {
                background-image: url(Resources/historyicon.png) !Important;
                background-repeat: no-repeat;
                background-position: left;
                background-size: 13px !important;
            }

            /* Investigation Work End */
            /* Filter Panel Start */

            .myfilter-panel {
                position: fixed;
                right: 0;
                top: 0;
                width: 300px;
                height: 100%;
                background-color: #f4f4f4;
                box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                overflow: scroll;
                z-index: 99999;
                padding: 10px;
                border-radius: 4px;
                margin-top: 5px;
                background-color: var(--colors_backgroundcolor);
            }

            /* Filter Panel End */

            .myfilter-panel.active {
                transform: translateX(0);
            }

            .filter-field {
                margin-top: 10px !Important;
                display: flex !Important;
                justify-content: center !Important;
                border-bottom: 1px solid white;
            }
        </style>
    </head>
    <div id="container">
        <!-- Your content goes here -->
    </div>
    <div class="panel PanelWithBorder Panel_BaseColor">
        <!-- <div id="PanelHeader_DVPANEL_TABLEATTRIBUTESContainer" class="panel-heading PanelWithBorder_Header Panel_BaseColor_Header">
<h3 class="panel-title"><span id="Title_DVPANEL_TABLEATTRIBUTESContainer">Cards Match Item</span></h3>
</div> -->

        <div class="panel-body">
            <!-- <div id="filterPanel">
                <p id="filterMessage">Filtered by: None</p>
                <button id="clearFilterButton" class="Button btn btn-default clearFilterButton" type="button"><i
                        class="fa fa-remove"></i></button>
                <button id="saveFilterButton" class="Button btn btn-default clearFilterButton" type="button"><i
                        class="fa fa-save"></i></button>
            </div> -->
            <div id="mainHeader">
                <div id="mainHeaderLeft" style="float: left;">

                </div>
            </div>
            <div class="table-responsive">
                <table id="dataTable"
                    class="display table table-bordered gx-tab-spacing-fix-2 GridWithPaginationBar GridWithBorderColor WorkWith table-responsive">
                    <thead id="tableHeader">
                        <!-- Table header will be populated dynamically by JavaScript -->
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>
        <div class="panel-footer">
            <div class="form-group">
                <div class="col-md-12">
                    <div class="col-md-1" style="Padding-top:8px">
                        <label for="pageLength">Page Length:</label>
                    </div>
                    <div class="col-md-2">
                        <select id="pageLength" class="form-control">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="300">300</option>
                        </select>
                    </div>

                </div>
            </div>
        </div>



    </div>
    <!-- Investigation Start -->
    <div id="fullScreenDiv">
        <div id="grayContainer"></div>
    </div>
    <div id="floatingContainerStartInvestigation" class="floatingContainerClass">
        <div id="floatingContainerTitleStartInvestigation" style="color: #000;" class="TextBlockTitleMaterial">
            Start Investigation
        </div>
        <div style="margin-top: 20px; font-size: 12px;">
            <div>To: </div>
            <div class="tag-input-container" id="tag-input-container">
                <!-- Tags will be dynamically added here -->
                <input list="deparments" type="text" id="tag-input" class="tag-input"
                    placeholder="Add one or more recipients" onkeydown="inputCheckSpace(this.value, event);">
                <datalist id="deparments">
                    <option value="IT" label="IT Department">
                    <option value="Branch" label="Branch Manager">
                    <option value="Accounting" label="Accounting Department">
                    <option value="General" label="General Management">
                </datalist>
            </div>

            <div>Subject: </div>
            <div class="tag-input-container">
                CASE ID #XXXXXX
                <input type="text" id="caseIdSubject" class="tag-input" placeholder="">
            </div>

            <div>Comments: </div>
            <textarea id="floatingContainerCommentsStartInvestigation" rows="6"
                style="resize: none; width: 98%;"></textarea>
            <div>
                By clicking on "Continue", I accept to start an investigation over the selected transactions.
            </div>
        </div>
        <div style="margin-top: 20px;">
            <button id="buttonFloatingContainerStartInvestigationAccept"
                class="ButtonMaterial btn btn-default">Continue</button>
            <button id="buttonFloatingContainerStartInvestigationCancel"
                class="ButtonMaterialDefault btn btn-default">Cancel</button>
        </div>
    </div>

    <!-- Investigation End -->
    <div id="floatingContainer" class="floatingContainerClass">
        <div id="floatingContainerTitle" style="color: #000;" class="TextBlockTitleMaterial">
            You are about to force the matching of several transactions
        </div>
        <div style="margin-top: 20px; font-size: 12px;">
            <div>Comments: </div>
            <textarea id="floatingContainerComments" rows="6" style="resize: none; width: 98%;"></textarea>
            <div id="floatingContainerDescription">
                By clicking on "Continue", I accept to force the matching of the selected transactions.
            </div>
        </div>
        <div style="margin-top: 20px;">
            <button id="buttonFloatingContainerAccept" class="ButtonMaterial btn btn-default">Continue</button>
            <button id="buttonFloatingContainerCancel" class="ButtonMaterialDefault btn btn-default">Cancel</button>
        </div>
    </div>
    <div id="floatingContainerHistory" class="floatingContainerClass">
        <div id="floatingContainerHistoryTitle" style="color: #000;" class="TextBlockTitleMaterial">
            Transaction History
        </div>
        <div style="margin-top: 20px; font-size: 12px;">
            <div id="HistoryContainer">
            </div>
        </div>
        <div style="margin-top: 20px;">
            <button id="buttonFloatingContainerHistoryAccept" class="ButtonMaterial btn btn-default">Close</button>
        </div>
    </div>
    <div id="myfilterPanel" class="myfilter-panel">
        <div style="display: flex;justify-content: space-between;">
            <h4>Filters</h4>
            <button id="closeFilterPanel" class="Button btn btn-default clearFilterButton" style="height: fit-content;"
                type="button"><i class="fa fa-remove"></i></button>
        </div>
        <div id="myfilterFieldsContainer"></div>
    </div>
    <!-- <button id="openFilterPanel" type="button">Open Filters</button> -->

    <script>


        class ColumnSearchValue {
            constructor(columnName, searchValue) {
                this.columnName = columnName;
                this.searchValue = searchValue;
            }
        }
        class colGridFilter {
            constructor(columnValues = [], fieldName = '') {
                this.columnValues = columnValues; // Assigning passed array to children property
                this.fieldName = fieldName; // Assigning passed string to additionalField property
            }
        }
        var selectedColumnId = [];
        var SettlementIdVal = '';
        var listColumnGridFilter = [];
        var FilterColumnPosition = [];
        var FilterColumnVis = [];
        var table;
        var savedFilterId = 0;
        var filteredColList = [];
        var filteredColJson = '';
        var currency = '';
        var invFilterVal = '';
        var settleCategoryIdVal = '';

        //Filter Variables
        var pFilter = {};

        //End
        const TrLifeCycleRolesActionLabel = ['', 'initiate', 'authorize', 'approve'];
        var acceptForceMatch = false;
        var isForceMatch = false;
        var p_TrLifeCycleRoles = 1;
        var authorizationPanel = false;

        $(document).ready(function () {

            if (fnGetPageName() == 'wpinvestigationcase') {
                $('#sumAmtdiv').hide();
            }
            var columnSearchValues = [];
            var chkOrder;
            var columnDefs = [];
            // $('#openFilterPanel').click(function () {
            //     $('#myfilterPanel').addClass('active');
            // });


            $('#closeFilterPanel').click(function () {
                $('#myfilterPanel').removeClass('active');
            });
            $.ajax({
                url: 'rest/wsCoronaUD',
                method: 'GET',
                data: {
                    //panelType: panelType
                },
                headers: {
                    'Authorization': pFilter.token
                },
                success: function (data) {
                    if (data && data.myCols && data.myCols.length > 0) {
                        var headerHtml = '';
                        var headerFilterHtml = '';
                        var headerFullHtml = '';
                        showLoader();
                        filteredColList = filteredColJson !== '[]' && filteredColJson !== '' ? JSON.parse(filteredColJson) : [];
                        data.myCols.unshift({ colIndex: 0, colName: 'Action', colDBName: 'Action', colDataType: 2 })

                        //Remove Some Column From Array

                        //End


                        if (filteredColList.length > 0) {


                            if (!filteredColList.includes('Action')) {
                                filteredColList.unshift('Action');
                            }


                            if (filteredColList.length > 0) {
                                const filteredCols = [];

                                // Iterate over filteredColList to filter data.myCols
                                filteredColList.forEach(function (colName) {
                                    const trimmedColName = colName.trim();
                                    const col = data.myCols.find(col => col.colDBName.trim() === trimmedColName);
                                    if (col) {
                                        filteredCols.push(col);
                                    }
                                });
                                data.myCols = filteredCols;

                            }
                        }
                        data.myCols = changeIndices(data.myCols);
                        data.myCols.forEach(function (column, indexs) {
                            if (column.colDBName == 'Action') {
                                // headerFilterHtml += '<th></th>'
                            } else {
                                if (column.colDataType == 'D') {
                                    //headerFilterHtml += '<th gx-tab-padding-fix-1 WWActionGroupColumn  GridWithPaginationBar GridWithBorderColor WorkWithTitle><div class="col-md-12"><input type="date" class="mycolumnSearchDate MyGridTextBox wwp-daterange-picker-input" placeholder="Search ' + column.colName + '" data-column="' + column.colDBName + '" /> </div>' + fnGenDropDown(indexs, 13, column.colDBName, column.colName) + '</th>';
                                    var columnDef = {
                                        "targets": indexs, // Assuming index corresponds to column index
                                        "render": function (data, type, row) {
                                            // Example: Format the data as needed, for example, convert it to uppercase
                                            return formatDateFromString(data);
                                        }
                                    };
                                    columnDefs.push(columnDef);
                                }
                                else if (column.colDataType == 'A') {
                                    //headerFilterHtml += '<th gx-tab-padding-fix-1 WWActionGroupColumn  GridWithPaginationBar GridWithBorderColor WorkWithTitle><div class="col-md-12"><input type="date" class="mycolumnSearchDate MyGridTextBox wwp-daterange-picker-input" placeholder="Search ' + column.colName + '" data-column="' + column.colDBName + '" /> </div>' + fnGenDropDown(indexs, 13, column.colDBName, column.colName) + '</th>';
                                    var columnDef = {
                                        "targets": indexs, // Assuming index corresponds to column index
                                        "render": function (data, type, row) {
                                            // Example: Format the data as needed, for example, convert it to uppercase
                                             return formatNumberWithCommas(data);
                                        }
                                    };
                                    columnDefs.push(columnDef);
                                }
                                else {
                                    //  headerFilterHtml += '<th gx-tab-padding-fix-1 WWActionGroupColumn  GridWithPaginationBar GridWithBorderColor WorkWithTitle><div class="col-md-12"><input type="text" class="mycolumnSearch MyGridTextBox"  data-column="' + column.colDBName + '" /></div>' + fnGenDropDown(indexs, 25, column.colDBName, column.colName) + '</th>';
                                }
                            }

                        });
                        //headerFullHtml = '<tr id ="searchInputs">' + headerFilterHtml + '</tr>';
                        data.myCols.forEach(function (column) {
                            headerHtml += '<th gx-tab-padding-fix-1 WWActionGroupColumn  GridWithPaginationBar GridWithBorderColor WorkWithTitle data-column="' + column.colDBName + '"><h5><b>' + column.colName + '</b></h5></th>';
                        });
                        headerFullHtml += '<tr id="columnHeaders">' + headerHtml + '</tr>';

                        $('#tableHeader').html(headerFullHtml);
                        var columnslist = data.myCols.map(function (column) {
                            if (column.colDBName == "Action" || column.colDBName == "DTranProcSign") {
                                return {
                                    data: column.colDBName,
                                    orderable: false,
                                    render: function (data, type, row) {
                                        if (column.colDBName == "Action") {
                                            var trIcons = '';
                                            if (row.InvStatus >= 1) {
                                                trIcons = '<i class="fas fa-search"></i>'
                                                //  return '<i class="fas fa-search"></i>'; // Display a check icon
                                            }
                                            if (row.TrGroupAuthorizationLevel >= 1) {
                                                if (row.TrGroupisForceStatusComplete == true) {
                                                    trIcons += ' <i class="fas fa-check"></i>(' + row.TrGroupAuthorizationLevel + ')'
                                                }
                                                else {
                                                    trIcons += ' <i class="fas fa-user"></i>(' + row.TrGroupAuthorizationLevel + ')'
                                                }
                                            }

                                            return trIcons;

                                        }
                                        else if (column.colDBName == "DTranProcSign") {
                                            return '<span style="color: black;font-size: small;font-weight: bolder;">' + row.DTranProcSign + '</span>'
                                        }
                                        else {
                                            return data;
                                        }
                                    }
                                };
                            } else {
                                return {
                                    data: column.colDBName
                                };
                            }

                        });
                        // Generate filter fields based on columns

                        var filterFieldsHtml = `<div id="filterPanel">
                <p id="filterMessage">Filtered by: None</p></div>`;
                        data.myCols.forEach(function (column, indexs) {

                            if (column.colDBName !== 'Action') {
                                filterFieldsHtml += '<div class="filter-field">';
                                filterFieldsHtml += fnGenDropDown(indexs, 25, column.colDBName, column.colName) + '<label style="margin-top: 5px" for="filter-' + column.colDBName + '">' + column.colName + '&nbsp</label>';
                                if (column.colDataType == 'D') {
                                    filterFieldsHtml += '<input type="date" class="mycolumnSearchDate MyGridTextBox wwp-daterange-picker-input" placeholder="Search ' + column.colName + '" data-column="' + column.colDBName + '" />'; //+ fnGenDropDown(indexs, 13, column.colDBName, column.colName);
                                } else {
                                    filterFieldsHtml += '<input type="text" class="mycolumnSearch MyGridTextBox"  data-column="' + column.colDBName + '" />';
                                }
                                filterFieldsHtml += '</div>';
                            }
                        });
                        $('#myfilterFieldsContainer').html(filterFieldsHtml);
                        if ($('#GRIDFILTER_GRIDFILTERDDLFILTER').val() !== undefined) {
                            listColumnGridFilter = [];
                            listColumnGridFilter = $('#GRIDFILTER_GRIDFILTERDDLFILTER').val() !== '[]' && $('#GRIDFILTER_GRIDFILTERDDLFILTER').val() !== '' ? JSON.parse($('#GRIDFILTER_GRIDFILTERDDLFILTER').val()) : [];
                        }
                        if ($('#GRIDFILTER_GRIDFILTERCOLUMNPOSITION').val() !== undefined) {
                            FilterColumnPosition = [];
                            FilterColumnPosition = $('#GRIDFILTER_GRIDFILTERCOLUMNPOSITION').val() !== '[]' && $('#GRIDFILTER_GRIDFILTERCOLUMNPOSITION').val() !== '' ? JSON.parse($('#GRIDFILTER_GRIDFILTERCOLUMNPOSITION').val()) : [];
                        }
                        if ($('#GRIDFILTER_GRIDFILTERCOLUMNVIS').val() !== undefined) {
                            FilterColumnVis = [];
                            var FilterColumnVisN = $('#GRIDFILTER_GRIDFILTERCOLUMNVIS').val() !== '[]' && $('#GRIDFILTER_GRIDFILTERCOLUMNVIS').val() !== '' ? $('#GRIDFILTER_GRIDFILTERCOLUMNVIS').val() : '[]';
                            FilterColumnVis = JSON.parse(FilterColumnVisN.trim());
                        }
                        updateFilterMessage();
                        table = $('#dataTable').DataTable({
                            processing: true,
                            serverSide: true,
                            paging: true,
                            pageLength: 50,
                            timeout: 9000000,
                            order: [[1, 'asc']],
                            ajax: {
                                url: 'rest/wsCoronaUD',
                                type: 'GET',
                                headers: {
                                    'Authorization': pFilter.token
                                },
                                data: function (d) {
                                    var searchData = {};
                                    $('.columnSearch').each(function () {
                                        var column = $(this).data('column');
                                        var value = $(this).val();
                                    });
                                    var jsonStrin = JSON.stringify(columnSearchValues);
                                    chkOrder = d.order[0].column;
                                    return {
                                        draw: d.draw,
                                        start: d.start,
                                        length: d.length,
                                        searchValue: d.search.value,
                                        sortColumn: d.columns[d.order[0].column].data,
                                        sortDirection: d.order[0].dir,
                                        columnSearchFilter: jsonStrin,
                                        colGridFilterStr: JSON.stringify(listColumnGridFilter),
                                        pFilterStr: JSON.stringify(pFilter),
                                    };
                                },
                                dataSrc: function (response) {
                                    if (response.data != '') {
                                        response.data = JSON.parse(response.data);
                                        return response.data;
                                    } else {
                                        return response.data;
                                    }
                                }

                            },

                            drawCallback: function (settings) {
                                // Assuming you get pFilter as part of your server response or you have it available
                                // if ($('.context-menu-list').length > 1) {
                                //     $('.context-menu-list').last().remove();
                                // };
                                updateContextMenu(pFilter);

                            },
                            rowCallback: function (row, data, index) {
                                if (data.GUSTAT.startsWith('M')) {
                                    $(row).css('color', 'green');
                                } else if (data.GUSTAT.startsWith('O')) {
                                    $(row).css('color', 'red');
                                }
                                else if (data.GUSTAT.startsWith('P')) {
                                    $(row).css('color', '#eed202');
                                }
                            },
                            // rowGroup: {
                            //     dataSrc: function (row) {
                            //         if (chkOrder == 2) {
                            //             return 'Group ID  : ' + row.DGrpId;
                            //         } else {
                            //             return null;
                            //         }
                            //     }
                            // },
                            columns: columnslist,
                            "colReorder": true,
                            dom: 'Bfrtip',
                            buttons: [
                                {
                                    extend: 'csv',
                                    text: '<i class="fa fa-download"></i> CSV'
                                },
                                {
                                    extend: 'colvis',
                                    text: '<i class="fa fa-columns"></i> Column Visibility'
                                },
                                {
                                    text: '<i class="fa-solid fa-save"></i> Save',
                                    action: function (e, dt, node, config) {
                                        $(node).attr('id', 'saveFilterButton');
                                        fnsaveFilterButton();
                                    },
                                    init: function (dt, node, config) {
                                        $(node).attr('id', 'saveFilterButton');
                                        $(node).addClass('dt-button buttons-collection buttons-colvis');
                                    }
                                },
                                {
                                    text: '<i class="fa-solid fa-remove"></i> Clear',
                                    action: function (e, dt, node, config) {
                                        $(node).attr('id', 'clearFilterButton');
                                        fnclearFilterButton();
                                    },
                                    init: function (dt, node, config) {
                                        $(node).attr('id', 'clearFilterButton');
                                        $(node).addClass('dt-button buttons-collection buttons-colvis');
                                    }
                                },
                                {
                                    text: '<i class="fa-solid fa-search"></i> Search',
                                    action: function (e, dt, node, config) {
                                        $(node).attr('id', 'buttons-searchButton');
                                        fnShowPanel();
                                    },
                                    init: function (dt, node, config) {
                                        $(node).attr('id', 'buttons-searchButton');
                                        $(node).addClass('dt-button buttons-collection buttons-colvis');
                                    }
                                },
                                {
                                    text: '<i class="fa-solid fa-filter"></i> Filters',
                                    action: function (e, dt, node, config) {
                                        $(node).attr('id', 'buttons-filterButton');
                                        $('#myfilterPanel').toggleClass('active');
                                    },
                                    init: function (dt, node, config) {
                                        $(node).attr('id', 'buttons-filterButton');
                                        $(node).addClass('dt-button buttons-collection buttons-colvis');
                                    }
                                }


                            ],
                            "columnDefs": columnDefs,
                            initComplete: function () {
                                var api = this.api();
                                // Handle row selection
                                // $('#dataTable tbody').on('click', 'tr:not(.dtrg-group)', function () {
                                //     if (invFilterVal == '') {
                                //         if (settleCategoryIdVal == '') {
                                //             $(this).toggleClass('selected');
                                //             updateSelectedRows();
                                //         }
                                //     }

                                // });

                                $('#dataTable tbody').on('click', 'tr:not(.dtrg-group)', function (event) {
                                    // Agar invFilterVal aur settleCategoryIdVal ki conditions match ho rahi hain
                                    if (invFilterVal == '') {
                                        if (settleCategoryIdVal == '') {
                                            // Agar Ctrl key press nahi hai toh sirf ek row select ho
                                            if (!event.ctrlKey) {
                                                $('#dataTable tbody tr').removeClass('selected'); // Baaki rows ka selection hata de
                                                $(this).addClass('selected'); // Sirf current row ko select kare
                                            } else {
                                                // Agar Ctrl key press hai, toh toggle selection for multiple rows
                                                $(this).toggleClass('selected');
                                            }

                                            // Selected rows ko update karein
                                            updateSelectedRows();
                                        }
                                    }
                                });





                            }
                        });

                        table.on('draw.dt', function () {
                            if (chkOrder != 2) {
                                // Hide the group row after the table has been drawn
                                $('#dataTable tbody tr.dtrg-group').css('display', 'none');
                            }
                        });



                        $("#dataTable thead").sortable({
                            items: "> th",
                            cursor: "move",
                            axis: "x",
                            stop: function (event, ui) {
                                var columnIndexOrder = [];
                                $("#dataTable th").each(function () {
                                    var columnData = $(this).data("column");
                                    columnIndexOrder.push(table.column(columnData + ":name").index());
                                });

                                table.colReorder.order(columnIndexOrder);
                                table.draw(false);
                            }
                        }).disableSelection();
                        if (FilterColumnPosition != null && FilterColumnPosition.length > 0) {
                            table.colReorder.order(FilterColumnPosition);
                            table.draw(false);
                        }
                        if (FilterColumnVis != null && FilterColumnVis.length > 0) {
                            var visibilityIndices = $.map(FilterColumnVis, function (col, index) {
                                if (col === false) {
                                    return index;
                                }
                            });
                            visibilityIndices.forEach(function (stateInd, index) {
                                table.column(stateInd).visible(false);

                            });
                        }
                        table.on('column-reorder', function (e, settings, details) {
                            var orderq = table.colReorder.order();
                            if (savedFilterId > 0) {
                                $.ajax({
                                    url: 'rest/wsSaveColGridFilter',
                                    type: 'GET',
                                    dataType: 'json',
                                    headers: {
                                        'Authorization': pFilter.token
                                    },
                                    data: {
                                        filterJson: JSON.stringify(listColumnGridFilter),
                                        savedFilterId: savedFilterId,
                                        FilterColumnPosition: JSON.stringify(orderq),
                                        FilterColumnVis: JSON.stringify(FilterColumnVis)
                                    },
                                    contentType: 'application/json; charset=UTF-8',
                                    success: function (data) {
                                        // alert('Filter Saved');
                                        //console.log(data);
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error:', error);
                                    }
                                });
                            } else {
                                FilterColumnPosition = JSON.stringify(orderq);
                            }
                            FilterColumnPosition = JSON.stringify(orderq);
                        });
                        table.on('column-visibility.dt', function (e, settings, column, state) {
                            
                            var visibility = table.columns().visible().toArray();
                            if (savedFilterId > 0) {
                                $.ajax({
                                    url: 'rest/wsSaveColGridFilter',
                                    type: 'GET',
                                    dataType: 'json',
                                    headers: {
                                        'Authorization': pFilter.token
                                    },
                                    data: {
                                        filterJson: JSON.stringify(listColumnGridFilter),
                                        savedFilterId: savedFilterId,
                                        FilterColumnPosition: JSON.stringify(FilterColumnPosition),
                                        FilterColumnVis: JSON.stringify(visibility)
                                    },
                                    contentType: 'application/json; charset=UTF-8',
                                    success: function (data) {
                                        // alert('Filter Saved');
                                        //console.log(data);
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error:', error);
                                    }
                                });
                            } else {
                                FilterColumnVis = JSON.stringify(visibility);
                            }
                            FilterColumnVis = JSON.stringify(visibility);
                        });
                    }
                    else {
                        alert('No columns available.' + data.errorDescription);
                    }
                    hideLoader();

                },
                error: function (e) {
                    console.log(e);
                    alert('Error occurred while fetching data.');
                }
            });
            function updateContextMenu(pFilter) {
                // Reset the contextMenuItems object
                $.contextMenu('destroy', '#dataTable tbody tr');
                contextMenuItems = {};

                // Conditionally add items based on the value of panelType

                debugger;
                if (pFilter.matchSts === "") {
                    contextMenuItems["Investigation"] = { name: "Start Investigation", icon: "inv" };
                    contextMenuItems["ForceUnMatch"] = { name: "Force UnMatch", icon: "unmatch" };
                    contextMenuItems["ForceMatch"] = { name: "Force Match", icon: "match" };
                    contextMenuItems["ViewHistory"] = { name: "View History", icon: "vhistory" };
                } else if (pFilter.matchSts === '%M%') {
                    contextMenuItems["ForceUnMatch"] = { name: "Force UnMatch", icon: "unmatch" };
                    contextMenuItems["ViewHistory"] = { name: "View History", icon: "match" };
                } else if (pFilter.matchSts === '%O%') {
                    contextMenuItems["Investigation"] = { name: "Start Investigation", icon: "inv" };
                    contextMenuItems["ForceMatch"] = { name: "Force Match", icon: "match" };
                    contextMenuItems["ViewHistory"] = { name: "View History", icon: "vhistory" };
                } else if (pFilter.matchSts.toString() === '4') {

                    if (fnGetPageName() == 'wpudauthorizationpending') {
                        contextMenuItems["Investigation"] = { name: "Start Investigation", icon: "inv" };
                        contextMenuItems["ForceMatch"] = { name: "Accept", icon: "match" };
                        contextMenuItems["RejectReq"] = { name: "Reject", icon: "unmatch" };
                        contextMenuItems["ViewHistory"] = { name: "View History", icon: "vhistory" };
                    }
                    else if (fnGetPageName() == 'wpudauthorizationunpending') {
                        contextMenuItems["Investigation"] = { name: "Start Investigation", icon: "inv" };
                        contextMenuItems["ForceUnMatch"] = { name: "Accept", icon: "match" };
                        contextMenuItems["RejectReqUM"] = { name: "Reject", icon: "unmatch" };
                        contextMenuItems["ViewHistory"] = { name: "View History", icon: "vhistory" };
                    }
                    else if (pFilter.NoAction == 1) {
                        contextMenuItems["NoAction"] = { name: "No Action", icon: "stop" };
                    } else {
                        contextMenuItems["Investigation"] = { name: "Start Investigation", icon: "inv" };
                        contextMenuItems["ForceMatch"] = { name: "Force Match", icon: "match" };
                        contextMenuItems["ForceUnMatch"] = { name: "Force UnMatch", icon: "unmatch" };
                        contextMenuItems["ViewHistory"] = { name: "View History", icon: "vhistory" };
                    }
                }
                else {
                    contextMenuItems["NoAction"] = { name: "No Action", icon: "stop" };
                }

                // Initialize the context menu
                $.contextMenu({
                    selector: '#dataTable tbody tr',
                    callback: function (key, options) {
                        var row = table.row(options.$trigger).data(); 
                        
                        const allLcSame = selectedColumnId.every(item => item.AccLifeCycleId === selectedColumnId[0].AccLifeCycleId);
                        if (key == 'Investigation') {
                            
                            const alreadyInv = selectedColumnId.find(e => e.InvStatus >= 1);
                            if (alreadyInv != null && alreadyInv.DataId != '') {
                                alert('Already in Investigation Id: ' + alreadyInv.DataId);
                            } else {
                                showFloatingContainerStartInvestigation();
                            }
                        } else if (key == 'ForceMatch') {
                            
                            const isOnlyOpen = selectedColumnId.every(item => item.GUSTAT.startsWith('O'));
                            if (allLcSame  && isOnlyOpen) {
                                acceptForceMatch = true;
                                fnGetAuthLevel(selectedColumnId[0].AccLifeCycleId, true, true);
                            } else {
                                if (!allLcSame) {
                                    alert('Please select one Life Cycle transactions for force match');
                                }
                                if (!isOnlyOpen) {
                                    alert('Please select only open transactions for force match');
                                }
                            }
                        }
                        else if (key == 'ForceUnMatch') {
                            const isOnlyMatch = selectedColumnId.every(item => item.GUSTAT.startsWith('M'));
                            if (allLcSame && isOnlyMatch) {
                                acceptForceMatch = true;
                                fnGetAuthLevel(selectedColumnId[0].AccLifeCycleId, true, false);
                            } else {
                               if (!isOnlyMatch) {
                                    alert('Please select only Match transactions for force Un match');
                                }
                            }
                        }
                        else if (key == 'RejectReq') {
                            if (allLcSame) {
                                fnGetAuthLevel(selectedColumnId[0].AccLifeCycleId, false, true);
                                acceptForceMatch = false;
                            } else {
                                alert('Please select same match set transactions for this action');
                            }
                        }
                        else if (key == 'RejectReqUM') {
                            if (allLcSame) {
                                fnGetAuthLevel(selectedColumnId[0].AccLifeCycleId, false, false);
                                acceptForceMatch = false;
                            } else {
                                alert('Please select same match set transactions for this action');
                            }
                        }
                        else if (key == 'ViewHistory') {
                            viewHistory(selectedColumnId[0].DataId, selectedColumnId[0].AccLifeCycleId);
                        }
                    },
                    items: contextMenuItems
                });
            }

            // Event listener for column search input
            $('#myfilterFieldsContainer').on('change', '.mycolumnSearch', function (e) {
                
                var columnName = $(this).data('column');
                var searchValue = $(this).val();
                var existingSearch = columnSearchValues.find(function (search) {
                    return search.columnName === columnName;
                });

                if (existingSearch) {
                    existingSearch.searchValue = searchValue;
                } else {
                    columnSearchValues.push(new ColumnSearchValue(columnName, searchValue));
                }
                // Trigger DataTables to reload data
                table.ajax.reload();
            });
            $('#myfilterFieldsContainer').on('change', '.mycolumnSearchDate', function (e) {
                
                var columnName = $(this).data('column');
                var searchValue = $(this).val();
                searchValue = formatDateToText(searchValue)
                var existingSearch = columnSearchValues.find(function (search) {
                    return search.columnName === columnName;
                });
                if (existingSearch) {
                    existingSearch.searchValue = searchValue;
                } else {
                    columnSearchValues.push(new ColumnSearchValue(columnName, searchValue));
                }
                // Trigger DataTables to reload data
                table.ajax.reload();
            });
            $('#pageLength').on('change', function () {
                table.page.len($(this).val()).draw();
            });
            // Function to update selected rows
            function updateSelectedRows() {
                var selectedRows = table.rows('.selected').data();
                selectedColumnId = [];
                selectedRows.each(function (row, index) {
                    selectedColumnId.push({ DataId: row.GUGLGID,GUSTAT: row.GUSTAT, AccLifeCycleId: row.ContainerId});
                });
            //     var sumC = 0;
            //     var sumD = 0;

            //     // Iterate through each item in the data array
            //     $.each(selectedColumnId, function (index, item) {
            //         if (item.Sign === "C") {
            //             sumC += item.Amount;
            //         } else if (item.Sign === "D") {
            //             sumD += item.Amount;
            //         }
            //     });

            //     // Calculate Sum of C - Sum of D
            //     var result = (sumC - sumD).toFixed(4);
            //     $('#sum-Amt').text(result);
            // }

            getDepartments();
            }

        });
        function fnGenDropDown(uniqueIndex, mleft, coldbName, colName) {
            var dropdownHtml = '<span  class="dropdown" style="margin-top: 2px;margin-left: -13px;">' +
                '<button  type="button" class="btn btn-sm dropdown-toggle dropdownMenuButton loader-btn" style="background-color: transparent;" data-colDbName="' + coldbName + '" data-colName="' + colName + '" onclick="fnLoadSelect(' + uniqueIndex + ')" type="button" id="dropdownMenuButton' + uniqueIndex + '" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
                '<i class="fa-solid fa-filter" style="font-size: 14px;"></i>' +
                '</button >' +
                '<div class="dropdown-menu" Id="dropdownMenuButtonChild' + uniqueIndex + '" aria-labelledby="dropdownMenuButton' + uniqueIndex + '">' +
                '<select id="gridFilterDD' + uniqueIndex + '" multiple="multiple"></select>' +
                '<button id="searchButtonDDFilter' + uniqueIndex + '" type="button" class="btn btn-primary btnSearchDD"> <i class="fas fa-search"></i></button>' +
                '</div>' +
                '</span>';

            return dropdownHtml;
        }
        function addEventListeners(uniqueIndex) {

            var dropdownBtn = document.getElementById('dropdownMenuButtonChild' + uniqueIndex);
            var dropdownSearchBtn = document.getElementById('searchButtonDDFilter' + uniqueIndex);
            dropdownSearchBtn.addEventListener('click', function (event) {
                event.stopPropagation();
                table.ajax.reload();
            });
            // alert('here')

            // Add click event listener to the dropdown button
            dropdownBtn.addEventListener('click', function (event) {
                // Stop event propagation to prevent closing the parent dropdown
                event.stopPropagation();
                // 
                // Toggle the dropdown menu visibility
                var dropdownMenu = this;
                var divd = dropdownMenu.querySelector('.btn-group');
                divd.classList.add('open');
                //dropdownMenu.classList.toggle('open');
            });
        }

        function fnLoadSelect(indexSelect) {
            
            var colname = $('#dropdownMenuButton' + indexSelect).data('colname');
            var coldbName = $('#dropdownMenuButton' + indexSelect).data('coldbname');
            var btnDDL = $('#dropdownMenuButton' + indexSelect);
            var filterDDL = $('#dropdownMenuButtonChild' + indexSelect);
            filterDDL.prop('disabled', true); // Disable the button
            btnDDL.addClass('loader');
            $.ajax({
                url: 'rest/wsGetFoCoronaGridSelect', // Replace with your server endpoint URL
                type: 'GET',
                data: {
                    FieldName: coldbName,
                    pFilterStr: JSON.stringify(pFilter),
                },
                headers: {
                    'Authorization': pFilter.token
                },
                success: function (data) {
                    // Populate multiselect dropdown with fetched data
                    $.each(data.listSelect, function (index, item) {
                        $('#gridFilterDD' + indexSelect).append('<option value="' + item.colValue + '">' + item.colValue + '</option>');
                    });

                    // Initialize multiselect dropdown
                    $('#gridFilterDD' + indexSelect).multiselect({
                        buttonWidth: '200px', // Adjust button width as needed
                        maxHeight: 300,
                        nonSelectedText: `Select ${colname}`,
                        enableFiltering: true, // Enable filtering in dropdown
                        onChange: function (element, checked) {
                            var selectedValues = $('#gridFilterDD' + indexSelect).val();
                            if (selectedValues != '') {
                                var existingSearch = listColumnGridFilter.find(function (search) {
                                    return search.fieldName === coldbName;
                                });
                                if (existingSearch) {
                                    // existingSearch.searchValue = searchValue;
                                    const filteredList = listColumnGridFilter.filter(filterItem => filterItem.fieldName !== coldbName);
                                    listColumnGridFilter = filteredList;
                                    listColumnGridFilter.push(new colGridFilter(selectedValues, coldbName))
                                } else {
                                    listColumnGridFilter.push(new colGridFilter(selectedValues, coldbName))
                                    // columnSearchValues.push(new ColumnSearchValue(columnName, searchValue));
                                }
                                updateFilterMessage();

                            } else {
                                var existingSearchN = listColumnGridFilter.find(function (search) {
                                    return search.fieldName === coldbName;
                                });
                                if (existingSearchN) {
                                    // existingSearch.searchValue = searchValue;
                                    const filteredList = listColumnGridFilter.filter(filterItem => filterItem.fieldName !== coldbName);
                                    listColumnGridFilter = filteredList;
                                    console.log(filteredList)
                                    // listColumnGridFilter.push(new colGridFilter(selectedValues, coldbName))
                                }
                                updateFilterMessage();
                            }
                        }
                    });
                    addEventListeners(indexSelect);
                    btnDDL.removeClass('loader'); // Remove loading class
                    filterDDL.prop('disabled', false);
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching data:', error);
                    btnDDL.removeClass('loader'); // Remove loading class
                    filterDDL.prop('disabled', false);
                }
            });

        }

        //region
        // Pagination variables
        let offset = 0;
        const limit = 20;
        let hasMoreData = true;
        let buttonshow = 0;

        function fnLoadSelect(indexSelect, Next = 0) {
            if (Next == 0) {
                offset = 0;
                GetForReportGridSelect(indexSelect, Next);
            } else {
                offset += limit;
                GetForReportGridSelect(indexSelect, Next);
            }
        }

        function GetForReportGridSelect(indexSelect, Next) {
            var colname = $('#dropdownMenuButton' + indexSelect).data('colname');
            var coldbName = $('#dropdownMenuButton' + indexSelect).data('coldbname');
            var btnDDL = $('#dropdownMenuButton' + indexSelect);
            var filterDDL = $('#dropdownMenuButtonChild' + indexSelect);

            // Disable button and show loading state
            filterDDL.prop('disabled', true);
            btnDDL.addClass('loader');

            $.ajax({
                url: 'rest/wsGetForGridSelectCashPaging', // Replace with your server endpoint URL
                type: 'GET',
                headers: {
                    'Authorization': pFilter.token
                },
                data: {
                    FieldName: coldbName,
                    pFilterStr: JSON.stringify(pFilter),
                    offset: offset,
                    limit: limit,
                },
                success: function (data) {
                    if (data.listSelect.length < limit) {
                        hasMoreData = false;
                    } else {
                        hasMoreData = true;
                    }

                    $('#gridFilterDD' + indexSelect).empty();
                    // Populate multiselect dropdown with fetched data
                    $.each(data.listSelect, function (index, item) {
                        if (item.colValue.length > 0) {
                            $('#gridFilterDD' + indexSelect).append('<option value="' + item.colValue + '">' + item.colValue + '</option>');
                        }
                    });



                    if (hasMoreData && Next == 0 && buttonshow == 0) {
                        buttonshow = 1;
                        $('#dropdownMenuButtonChild' + indexSelect).append(
                            '<button id="NextButtonFilter" type="button"  onclick="fnLoadSelect(' + indexSelect + ', 1)" class="btn btn-primary"><i class="fa fa-arrow-right"></i></button>'
                        );
                    }


                    // Initialize multiselect dropdown
                    $('#gridFilterDD' + indexSelect).multiselect({
                        buttonWidth: '200px',
                        maxHeight: 300,
                        nonSelectedText: `Select ${colname}`,
                        enableFiltering: true,
                        onChange: function (element, checked) {
                            var selectedValues = $('#gridFilterDD' + indexSelect).val();
                            if (selectedValues != '') {
                                var existingSearch = listColumnGridFilter.find(function (search) {
                                    return search.fieldName === coldbName;
                                });
                                if (existingSearch) {
                                    const filteredList = listColumnGridFilter.filter(filterItem => filterItem.fieldName !== coldbName);
                                    listColumnGridFilter = filteredList;
                                    listColumnGridFilter.push(new colGridFilter(selectedValues, coldbName));
                                } else {
                                    listColumnGridFilter.push(new colGridFilter(selectedValues, coldbName));
                                }
                                updateFilterMessage();

                            } else {
                                var existingSearchN = listColumnGridFilter.find(function (search) {
                                    return search.fieldName === coldbName;
                                });
                                if (existingSearchN) {
                                    const filteredList = listColumnGridFilter.filter(filterItem => filterItem.fieldName !== coldbName);
                                    listColumnGridFilter = filteredList;
                                }
                                updateFilterMessage();
                            }
                        }
                    });


                    $('#gridFilterDD' + indexSelect).multiselect('rebuild');

                    //Close the dropdown after loading new data
                    if (Next === 1) {
                        btnDDL.removeClass('loader');
                        btnDDL.dropdown('hide'); // Manually close dropdown after clicking "Next"
                    }

                    addEventListeners(indexSelect);
                    btnDDL.removeClass('loader'); // Remove loading class
                    filterDDL.prop('disabled', false);
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching data:', error);
                    btnDDL.removeClass('loader'); // Remove loading class
                    filterDDL.prop('disabled', false);
                }
            });
        }


        //endregion
        function fnclearFilterButton() {
            // This function will be called when the button with id "myButton" is clicked
            listColumnGridFilter = [];
            updateFilterMessage();
            table.ajax.reload();
            // Add your code here to perform actions when the button is clicked
        };
        function fnsaveFilterButton() {
            
            if (savedFilterId > 0) {
                $.ajax({
                    url: 'rest/wsSaveColGridFilter',
                    type: 'GET',
                    dataType: 'json',
                    headers: {
                        'Authorization': pFilter.token
                    },
                    data: {
                        filterJson: JSON.stringify(listColumnGridFilter),
                        FilterColumnPosition: JSON.stringify(FilterColumnPosition),
                        FilterColumnVis: JSON.stringify(FilterColumnVis),
                        savedFilterId: savedFilterId
                    },
                    contentType: 'application/json; charset=UTF-8',
                    success: function (data) {
                        $('#TABLECONTAINERSAVEFILTER').addClass("DisplayNone");
                        //  $('#BTNBTNSAVEContainer button').click();
                        alert('Filter Saved');
                        //console.log(data);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                    }
                });
            }
            else {
                $('#TABLECONTAINERSAVEFILTER').removeClass("DisplayNone");
                document.getElementById("GRIDFILTER_GRIDFILTERNAME").focus();
            }
        };
        function updateFilterMessage() {

            var filtertext = ''
            var childText = ''
            if (listColumnGridFilter.length > 0) {
                listColumnGridFilter.forEach((parent, indexp) => {
                    // console.log(parent.fieldName);
                    filtertext += `${parent.fieldName} in (`;
                    childText = ''
                    parent.columnValues.forEach((child, index) => {
                        // console.log(child);
                        childText += `,${child}`
                    });
                    childText += `) `;
                    childText = childText.substring(1, childText.length)
                    filtertext += childText;
                });
            }
            var filtermsg = "Filtered by: ";
            document.getElementById("filterMessage").textContent = filtertext == '' ? filtermsg + 'None' : filtermsg + filtertext;
        }

        async function callWebService(serviceURL, inComments) {
            var data = {
                AccLifeCycleId: selectedColumnId[0].AccLifeCycleId,
                sTDataGroupMatchKey: selectedColumnId.map(e => e.DataId),
                sTDataGroupComment: inComments,
                acceptForceMatch: acceptForceMatch
            };

            fetch(serviceURL, {
                method: "POST",
                //mode: "no-cors",
                body: JSON.stringify(data),
                headers: { "Content-type": "application/json; charset=UTF-8", 'Authorization': pFilter.token }
            })
                .then(response => response.json())
                .then(res => {

                    if (res.errorDescription != '') {
                        alert(res.errorDescription);
                    }

                    if (res.error == 0) {
                        if (authorizationPanel) {
                            //location.reload(true);
                            table.ajax.reload();
                        }
                        else {
                            hideFloatingContainer();
                            table.ajax.reload();
                        }
                    }
                });
        };


        function downloadVoucher() {
            // alert('testing');
            $.ajax({
                url: 'rest/wsFileDownload',
                type: 'GET',
                headers: {
                    'Authorization': pFilter.token
                },
                // dataType: 'json',
                // data: {
                //     panelType: panelType,
                //     fromDateStr: formatDate($('#vFROMDATE').val()),
                //     toDateStr: formatDate($('#vTODATE').val()),
                //     pphysname: $('#vPPHYSNAME').val(),
                // },
                contentType: 'application/json; charset=UTF-8',
                success: function (data) {
                    // alert('test');
                    var base64String = data.base64;
                    downloadBase64String('xlsx', base64String);
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                }
            });
        }

    </script>
    <script>
        var SDT_InvTemplate = [];
        function showFloatingContainerStartInvestigation() {
            document.getElementById('fullScreenDiv').style.display = 'block';
            document.getElementById('floatingContainerStartInvestigation').style.zIndex = '20';
            document.getElementById('floatingContainerStartInvestigation').style.opacity = 1;
            document.getElementById('floatingContainerStartInvestigation').style.top = '70px';
        }
        function hideFloatingContainerStartInvestigation() {
            document.getElementById('fullScreenDiv').style.display = 'none';
            document.getElementById('floatingContainerStartInvestigation').style.zIndex = '-1';
            document.getElementById('floatingContainerStartInvestigation').style.opacity = 0;
            document.getElementById('floatingContainerStartInvestigation').style.top = '0px';
        }

        var tags = [];

        function addNewTag(tagName) {
            tags.push(tagName);
            renderTagHolder();
        }

        function deleteTag(tagName) {
            for (let i = 0; i < tags.length; i++) {
                if (tagName == tags[i]) {
                    tags.splice(i, 1);
                    break;
                }
            }

            renderTagHolder();
        }

        function renderTagHolder() {
            let auxHTML = '';

            tags.forEach(x => {
                auxHTML = auxHTML + `<div class="tag">
                                    <span>${x}</span>
                                    <span class="close" onclick="deleteTag('${x}')"><i class="fa fa-close"></i></span>
                                </div>`
            });

            let auxDataList = '<datalist id="departments">';

            SDT_InvTemplate.forEach(x => {
                if (tags.indexOf(x.InvTemplateId) < 0) {
                    auxDataList = auxDataList + `<option value="${x.InvTemplateId}" label="${x.InvTemplateDescription}">`;
                }
            });

            auxDataList = auxDataList + '</datalist>';

            document.getElementById("tag-input-container").innerHTML = auxHTML + `<input list="departments" type="text" id="tag-input" class="tag-input" placeholder="" onkeydown="inputCheckSpace(this.value, event);">`
                + auxDataList;
            document.getElementById("tag-input").focus();
        }

        async function getDepartments() {
            data = {
                Module: 'UD'
            };

            fetch('rest/wsGetDepartments', {
                method: "POST",
                //mode: "no-cors",
                body: JSON.stringify(data),
                headers: { "Content-type": "application/json; charset=UTF-8", 'Authorization': pFilter.token }
            })
                .then(response => response.json())
                .then(res => {
                    SDT_InvTemplate = res.SDT_InvTemplate;
                    renderTagHolder();
                });
        }
        function inputCheckSpace(val, event) {
            if (event.key === 'Enter' || event.key === ',' || event.key === ' ') {
                event.preventDefault();
                addNewTag(val);
            }
        }
        async function startInvestigation(inSubject, inComments) {
            console.log(selectedColumnId)

            var data = {
                InvestigationSubject: inSubject,
                InvestigationContent: inComments,
                colInvTemplateId: tags,
                sTDataGroupMatchKey: selectedColumnId.map(e => e.DataId),
                InvDataList: selectedColumnId,
                Module: "UD"
            };

            fetch('rest/wsStartInvestigationNew', {
                method: "POST",
                //mode: "no-cors",
                body: JSON.stringify(data),
                headers: { "Content-type": "application/json; charset=UTF-8", 'Authorization': pFilter.token }
            })
                .then(response => response.json())
                .then(res => {
                    if (res.error == 0) {
                        alert('Investigation started: Case #' + res.InvestigationCaseId);
                        hideFloatingContainerStartInvestigation();
                        table.ajax.reload();
                    }
                    else {
                        alert('Could not start an investigation: ' + res.errorDescription);
                    }
                });
        }
        document.getElementById("buttonFloatingContainerStartInvestigationAccept").addEventListener("click",
            (ev) => {
                ev.preventDefault();

                let sendSubject = document.getElementById('caseIdSubject').value;
                let sendComments = document.getElementById('floatingContainerCommentsStartInvestigation').value;

                if (sendComments) {
                    if (tags.length > 0) {
                        startInvestigation(sendSubject, sendComments)
                    }
                    else {
                        alert('The field "To" must contain at least one recipient.');
                    }
                }
                else {
                    alert('A comment must be entered in order to continue.');
                }

            }
            , false);
        document.getElementById("buttonFloatingContainerStartInvestigationCancel").addEventListener("click",
            (ev) => {
                ev.preventDefault();
                hideFloatingContainerStartInvestigation();
            }
            , false);
        document.getElementById("buttonFloatingContainerCancel").addEventListener("click",
            (ev) => {
                ev.preventDefault();
                hideFloatingContainer();
            }
            , false);
        function formatDate(inputDateString) {
            if (inputDateString == '' || inputDateString == null || inputDateString == '  /  /  ') {
                return ''
            }
            // Parse the input date string
            var parts = inputDateString.split('/');
            var month = parseInt(parts[0]);
            var day = parseInt(parts[1]);
            var year = parseInt(parts[2]);

            // Handle 2-digit years
            if (year < 100) {
                var currentYear = new Date().getFullYear();
                var currentCentury = Math.floor(currentYear / 100) * 100;
                var centuryOffset = currentYear % 100;

                if (year <= centuryOffset) {
                    // Year is in the current century
                    year += currentCentury;
                } else {
                    // Year is in the previous century
                    year += currentCentury - 100;
                }
            }

            // Create a Date object
            var date = new Date(year, month - 1, day); // Note: Month is zero-based in JavaScript Date object

            // Format the date as 'YYYYDDMM'
            var formattedDate = date.getFullYear() + ('0' + (date.getMonth() + 1)).slice(-2) + ('0' + date.getDate()).slice(-2);

            return formattedDate;
        }
        //Force Match Start
        async function fnGetAuthLevel(AccLifeCycleId, accept, isForceMatchPrm) {
            var data = {
                LCName: '',
                moduleName: 'UD',
                AccLifeCycleId: AccLifeCycleId
            };
            fetch('rest/wsGetTrLifeCycleRoleByLcName', {
                method: "POST",
                //mode: "no-cors",
                body: JSON.stringify(data),
                headers: { "Content-type": "application/json; charset=UTF-8", 'Authorization': pFilter.token }
            })
                .then(response => response.json())
                .then(res => {
                    if (res.errorDescription != '') {
                        alert(res.errorDescription);
                    }
                    else {
                        
                        p_TrLifeCycleRoles = res.TrLifeCycleRoleMatchUserRoles;
                        if (p_TrLifeCycleRoles == 0) {
                            alert('You have no right for this action');
                        } else {

                            isForceMatch = isForceMatchPrm;
                            showFloatingContainer(accept);
                        }
                    }
                });
        }


        function showFloatingContainer(accept) {


            acceptForceMatch = accept;
            if (accept) {
                document.getElementById('floatingContainerTitle').innerHTML = `You are about to ${TrLifeCycleRolesActionLabel[p_TrLifeCycleRoles]} the process of the selected transactions`;
                document.getElementById('floatingContainerDescription').innerHTML = `By clicking on "Continue", I accept to ${TrLifeCycleRolesActionLabel[p_TrLifeCycleRoles]} the process of the selected transactions.`;
            }
            else {
                document.getElementById('floatingContainerTitle').innerHTML = 'You are about to reject the process of the selected transactions';
                document.getElementById('floatingContainerDescription').innerHTML = 'By clicking on "Continue", I accept to reject the process of the selected transactions.';
            }

            document.getElementById('fullScreenDiv').style.display = 'block';
            document.getElementById('floatingContainer').style.zIndex = '20';
            document.getElementById('floatingContainer').style.opacity = 1;
            document.getElementById('floatingContainer').style.top = '70px';
        }

        document.getElementById("buttonFloatingContainerAccept").addEventListener("click",
            (ev) => {
                ev.preventDefault();
                let sendComments = document.getElementById('floatingContainerComments').value;
                
                if (sendComments) {
                    //   if(panelMode == 2 || panelMode == 3)
                    // {
                    if (isForceMatch) {
                        callWebService('rest/wsManualMatchTransactionsUD', sendComments);
                    }
                    else if (!isForceMatch) {
                        callWebService('rest/wsManualUnMatchTransactionsUD', sendComments);
                    }
                }
                else {
                    alert('A comment must be entered in order to continue.')
                }
            }
            , false);

        function hideFloatingContainer() {
            document.getElementById('fullScreenDiv').style.display = 'none';
            document.getElementById('floatingContainer').style.zIndex = '-1';
            document.getElementById('floatingContainer').style.opacity = 0;
            document.getElementById('floatingContainer').style.top = '0px';
        }
        function fnGetPageName() {
            var pathname = window.location.pathname; // gets the path part of the URL
            var pageName = pathname.substring(pathname.lastIndexOf('/') + 1).replace('.aspx', ''); // extracts the page name
            return pageName.toLowerCase();
        }
        //Force Match End
        //History Start
        async function viewHistory(DataId, GrpAccId) {
            
            var data = {
                DataId: DataId,
                GrpAccId: GrpAccId,
                Module: 'UD'
            };

            fetch('rest/wsGetTransactionHistory', {
                method: "POST",
                //mode: "no-cors",
                body: JSON.stringify(data),
                headers: { "Content-type": "application/json; charset=UTF-8", 'Authorization': pFilter.token }
            })
                .then(response => response.json())
                .then(res => {
                    renderHistory(res, DataId);
                    showFloatingContainerHistory();
                });
        }
        function renderHistory(r, TDataKey) {
            
            let allEvents = r.SDT_DataEvent.map(
                function (x) {
                    return {
                        InvestigationEventComments: x.TranEventComment,
                        InvestigationEventDateTime: x.TranEventDateTime,
                        InvestigationEventId: x.TranEventId,
                        InvestigationEventType: x.TranEventType,
                        InvestigationEventUser: x.TranEventUserId,
                        InvestigationEventUserName: x.TranEventUserName,
                        InvestigationEventIsMe: false
                    }
                }).concat(r.SDT_InvestigationCase.Event).sort(function (a, b) {
                    if (a.InvestigationEventDateTime < b.InvestigationEventDateTime) {
                        return -1;
                    }
                    else {
                        return 1;
                    }
                });

            let auxHTML1 = `<table style="display: block;" class="mainGridStyle header-fixed"><thead><tr><th class="thS">Creation Date</th><th class="thS">Match Status</th></tr></thead>
                    <tbody><tr><td class="cTdPad">${r.LoadDate.replace('T', ' ')}</td><td class="cTdPad">${r.MatchStatus}</td></tr></tbody></table> <br><br>`;
            let auxHTML = ''
            auxHTML = auxHTML + `<table style="display: block;" class="mainGridStyle header-fixed"><thead><tr><th class="thS">Date/Time</th><th class="thS">Event</th><th class="thS">User</th><th class="thS">Comments</th></tr></thead><tbody>`;

            try {
                allEvents.forEach(x => {
                    let typeDescription = getEventDescription(x.InvestigationEventType);
                    let tr = `<tr>
                                <td class="cTdPad">${x.InvestigationEventDateTime.replace('T', ' ')}</td>
                                <td class="cTdPad">${typeDescription}</td>
                                <td class="cTdPad">${x.InvestigationEventUserName}</td>
                                <td class="cTdPad">${x.InvestigationEventComments}</td>
                            </tr>`;
                    auxHTML = auxHTML + tr;
                });
            }
            catch (err) {
                //
            }

            auxHTML = auxHTML + `</tbody></table>`;
            document.getElementById('HistoryContainer').innerHTML = auxHTML;
        }
        document.getElementById("buttonFloatingContainerHistoryAccept").addEventListener("click",
            (ev) => {
                ev.preventDefault();
                hideFloatingContainerHistory();
            }
            , false);
        function hideFloatingContainerHistory() {
            document.getElementById('fullScreenDiv').style.display = 'none';
            document.getElementById('floatingContainerHistory').style.zIndex = '-1';
            document.getElementById('floatingContainerHistory').style.opacity = 0;
            document.getElementById('floatingContainerHistory').style.top = '0px';
        }

        function showFloatingContainerHistory() {
            document.getElementById('fullScreenDiv').style.display = 'block';
            document.getElementById('floatingContainerHistory').style.zIndex = '20';
            document.getElementById('floatingContainerHistory').style.opacity = 1;
            document.getElementById('floatingContainerHistory').style.top = '70px';
        }
        function getEventDescription(eventTypeId) {
            switch (eventTypeId) {
                case 'CRE':
                    return 'Case start';
                    break;
                case 'COM':
                    return 'Comment';
                    break;
                case 'FWD':
                    return 'Forward Case';
                    break;
                case 'ESC':
                    return 'Escalation';
                    break;
                case 'CLO':
                    return 'Case Close';
                    break;
                case 'INV':
                    return 'Investigation';
                    break;
                case 'Open':
                    return 'Open';
                    break;
                case 'FOR':
                    return 'Force Match: Complete';
                    break;
                case 'FM1':
                    return 'Force Match: Initiate';
                    break;
                case 'FM2':
                    return 'Force Match: Authorize';
                    break;
                case 'FM3':
                    return 'Force Match: Approve';
                    break;
                case 'FMR':
                    return 'Force Match: Reject';
                    break;
                case 'FUM':
                    return 'Force Unmatch: Complete';
                    break;
                case 'FGR':
                    return 'Force Group';
                    break;
                case 'UNG':
                    return 'Ungroup';
                    break;
                case 'UM1':
                    return 'Force Unmatch: Initiate';
                    break;
                case 'UM2':
                    return 'Force Unmatch: Authorize';
                    break;
                case 'UM3':
                    return 'Force Unmatch: Approve';
                    break;
                case 'UMR':
                    return 'Force Unmatch: Reject';
                    break;
                default:
                    return 'Unknown';
            }
        }

        //History End
    </script>
</body>